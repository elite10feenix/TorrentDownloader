<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Torrent Downloader iOS</title>
  <link rel="stylesheet" type="text/css" href="torrent.css">
</head>
<body>
  <div id="hero">
    <div id="torrentControls">
      <h2>Download Torrent</h2>
      <input type="text" id="torrentInput" placeholder="Enter torrent URL or magnet link">
      <button id="startButton">Start Download</button>
    </div>
    <div id="output">
      <div id="progressBar"></div>
      <!-- The video player will be added here -->
    </div>
    <div id="status">
      <div>
        <span class="show-leech">Downloading </span>
        <span class="show-seed">Seeding </span>
        <code><a id="torrentLink" href="#">Torrent File</a></code>
        <span class="show-leech"> from </span>
        <span class="show-seed"> to </span>
        <code id="numPeers">0 peers</code>.
      </div>
      <div>
        <code id="downloaded"></code> of <code id="total"></code>
        â€” <span id="remaining"></span><br/>
        &#x2198;<code id="downloadSpeed">0 b/s</code> / &#x2197;<code id="uploadSpeed">0 b/s</code>
      </div>
    </div>
    <div id="fileListSection">
      <h3>Download Finished. Click below to save files:</h3>
      <ul id="fileList"></ul>
    </div>
  </div>

  <!-- Include the latest version of WebTorrent -->
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

  <!-- Moment is used to show a human-readable remaining time -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

  <script type="text/javascript">
    const client = new WebTorrent();
    const $body = document.body;
    const $progressBar = document.querySelector('#progressBar');
    const $numPeers = document.querySelector('#numPeers');
    const $downloaded = document.querySelector('#downloaded');
    const $total = document.querySelector('#total');
    const $remaining = document.querySelector('#remaining');
    const $uploadSpeed = document.querySelector('#uploadSpeed');
    const $downloadSpeed = document.querySelector('#downloadSpeed');
    const $fileList = document.querySelector('#fileList');
    const $torrentInput = document.querySelector('#torrentInput');
    const $startButton = document.querySelector('#startButton');
    const $torrentLink = document.querySelector('#torrentLink');
    const $fileListSection = document.getElementById('fileListSection');

    let currentTorrent = null;
    let filesAdded = false;

    function startTorrentDownloadFromInput() {
      const torrentId = $torrentInput.value.trim();
      if (!torrentId) {
        alert('Please enter a torrent URL or magnet link.');
        return;
      }
      startTorrentDownload(torrentId);
    }

    function startTorrentDownloadFromFile() {
      const torrentId = window.location.href.split('?file=')[1];
      if (!torrentId) {
        alert('No torrent file specified.');
        return;
      }
      startTorrentDownload(torrentId);
    }

    function startTorrentDownload(torrentId) {
      $fileListSection.style.display = 'none';
      resetState();

      const loader = document.createElement('div');
      loader.className = 'loader';
      document.getElementById('hero').appendChild(loader);

      if (currentTorrent) {
        currentTorrent.destroy();
        currentTorrent = null;
      }

      client.add(torrentId, function (torrent) {
        currentTorrent = torrent;
        document.querySelector('.loader').remove();
        addFilesToList(torrent);
        $torrentLink.href = torrentId;

        torrent.on('done', onDone);
        setInterval(onProgress, 500);
        onProgress();

        function onProgress() {
          $numPeers.textContent = torrent.numPeers + (torrent.numPeers === 1 ? ' peer' : ' peers');
          const percent = Math.round(torrent.progress * 100 * 100) / 100;
          $progressBar.style.width = percent + '%';
          $downloaded.textContent = prettyBytes(torrent.downloaded);
          $total.textContent = prettyBytes(torrent.length);
          $remaining.textContent = getRemainingTime(torrent);
          $downloadSpeed.textContent = prettyBytes(torrent.downloadSpeed) + '/s';
          $uploadSpeed.textContent = prettyBytes(torrent.uploadSpeed) + '/s';
        }

        function onDone() {
          $body.classList.add('is-seed');
          onProgress();
        }
      });
    }

    function resetState() {
      $progressBar.style.width = '0%';
      $numPeers.textContent = '0 peers';
      $downloaded.textContent = '';
      $total.textContent = '';
      $remaining.textContent = '';
      $uploadSpeed.textContent = '0 b/s';
      $downloadSpeed.textContent = '0 b/s';
      $fileList.innerHTML = '';
    }

    function addFilesToList(torrent) {
      if (!filesAdded) {
        torrent.files.forEach(file => {
          const listItem = document.createElement('li');
          const fileName = file.name;
          const fileLink = document.createElement('a');
          fileLink.textContent = `Download ${fileName}`;
          fileLink.href = 'javascript:;';  

          fileLink.addEventListener('click', async () => {
            try {
              file.getBlob((err, blob) => {
                if (err) {
                  console.error('Error getting blob', err);
                  return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                  const base64 = reader.result.split(',')[1];
                  console.log({blobData:base64, fileName: fileName});
                  window.ReactNativeWebView.postMessage(JSON.stringify({blob: base64, fileName: fileName}));
                };
                reader.readAsDataURL(blob);
              });
            } catch (error) {
              console.error('Error handling file click', error);
            }
          });

          listItem.appendChild(fileLink);
          $fileList.appendChild(listItem);
         
        });
        $fileListSection.style.display = 'block';
        filesAdded = true;
      }
    }

    function getRemainingTime(torrent) {
      if (torrent.done) {
        return 'Done.';
      } else {
        let remaining = moment.duration(torrent.timeRemaining / 1000, 'seconds').humanize();
        return remaining[0].toUpperCase() + remaining.substring(1) + ' remaining.';
      }
    }

    function prettyBytes(num) {
      const units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
      const neg = num < 0;
      if (neg) num = -num;
      if (num < 1) return (neg ? '-' : '') + num + ' B';
      const exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1);
      const unit = units[exponent];
      num = Number((num / Math.pow(1000, exponent)).toFixed(2));
      return (neg ? '-' : '') + num + ' ' + unit;
    }

    $startButton.addEventListener('click', startTorrentDownloadFromInput);
    document.addEventListener('DOMContentLoaded', startTorrentDownloadFromFile);
  </script>
</body>
</html>
